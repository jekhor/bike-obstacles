var map;
var osb;
var mapnik;
var markers;
var selectControl;
var popup;
var cops;
var brokenContentSize;

function style_osm_feature(feature) {
    alert(0);
}

function osbug() {
    osbug_makeform();
}

function osbug_makeform() {
        var newContent = document.createElement("div");
        var el1,el2,el3;
        var control = osb;
        var types = {
                "kerb": "Kerb",
                "parked cars": "Parked cars",
                "pedestrians": "Pedestrians",
                "stairs": "Stairs",
                "dogs": "Dogs",
                "rough road": "Rough road",
                "other": "Other"
        };

        var el_form = document.createElement("form");

        newContent.appendChild(el_form);

        el1 = document.createElement("dl");

        el2 = document.createElement("dt");
        el2.appendChild(document.createTextNode(OpenLayers.i18n("Type:")));
        el1.appendChild(el2);
        el2 = document.createElement("dd");

        for (var i in types) {
                var obstacleType1 = document.createElement("input");
                obstacleType1.id = i;
                obstacleType1.value = i;
                obstacleType1.type = "radio";
                obstacleType1.name = "type";
                el2.appendChild(obstacleType1);
                var label = document.createElement("label");
                label.htmlFor = i;
                label.appendChild(document.createTextNode(OpenLayers.i18n(types[i])));
                el2.appendChild(label);
                el2.appendChild(document.createElement("br"));
        }

        el1.appendChild(el2);

        el2 = document.createElement("dt");
        el2.appendChild(document.createTextNode(OpenLayers.i18n("Your name:")));
        el1.appendChild(el2);
        el2 = document.createElement("dd");
        var inputUsername = document.createElement("input");
        if (osb.osbLayer.usernameshort != null) {
            if (osb.osbLayer.usernameshort == "") {
                osb.osbLayer.usernameshort = "anonymous";
            }
        } else {
            if (osb.osbLayer.username != null) {
                osb.osbLayer.usernameshort = osb.osbLayer.username;
            }
        }
        if (osb.osbLayer.usernameshort == "NoName") {
            osb.osbLayer.usernameshort = OpenLayers.i18n("NoName");
        }
        inputUsername.className = "osbUsername";
        inputUsername.id = "osbuser";
        el2.appendChild(inputUsername);
        el1.appendChild(el2);

        el2 = document.createElement("dt");
        el2.appendChild(document.createTextNode(OpenLayers.i18n("Your message:")));
        el1.appendChild(el2);
        el2 = document.createElement("dd");
        var inputDescription = document.createElement("input");
        inputDescription.id = "osbtext";
        el2.appendChild(inputDescription);
        el1.appendChild(el2);
        el_form.appendChild(el1);

        el1 = document.createElement("div");
        el2 = document.createElement("button");
        el2.innerHTML = OpenLayers.i18n("Say");
        el2.id = "saybtn";
        el1.appendChild(el2);
        el_form.appendChild(el1);

        popup.setContentHTML(newContent.innerHTML);
        $("kerb").checked = true;
        $("osbuser").value = osb.osbLayer.usernameshort;
        $("saybtn").onclick = function() {
                var l = popup.lonlat;
                var t = "";
                l.transform(map.projection,map.displayProjection)
                        /* if ($("osbuser").value == "NoName") {
                           alert(OpenLayers.i18n("Please fill in your name"));
                           return false;
                           } */

                var tmp = "";
                for (var i in types)
                        if ($(i).checked)
                                tmp = i;

                osb.osbLayer.setUserName($("osbuser").value);
                osb.osbLayer.usernameshort = $("osbuser").value;
                osb.osbLayer.createBug(l, t + $("osbtext").value, tmp);
                popup.setContentHTML(OpenLayers.i18n("Thanks for your response, it will be taken into account soon."));
                popup.updateSize();
                return false;
        };

        popup.updateSize();
}

function onPopupClose(evt) {
    if (popup) {
        map.removePopup(popup);
        popup.destroy();
        popup = null;
    }
}

function onFeatureSelect(evt) {
    var l = map.getLonLatFromViewPortPx(evt.xy);

    onPopupClose();
    if (map.zoom < 17) {
        map.setCenter(l, 17);
        return;
    }

    var name;

    popup = new OpenLayers.Popup.FramedCloud("featurePopup",
                             l,
                             new OpenLayers.Size(100,100),
                             "dummy",
                             null, true, onPopupClose);
    popup.updateSize();
    map.addPopup(popup);
    osbug_makeform()
}

function onFeatureUnselect(evt) {
    return;
}

function putAJAXMarker(id, lon, lat, text, closed, subtype)
{
    var comments = text.split(/<hr \/>/);
    for(var i=0; i<comments.length; i++)
        comments[i] = comments[i].replace(/&quot;/g, "\"").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");

    putAJAXMarker.bugs[id] = [
        new OpenLayers.LonLat(lon, lat),
        comments,
        closed,
        subtype
    ];
    for(var i=0; i<putAJAXMarker.layers.length; i++)
        putAJAXMarker.layers[i].createMarker(id);
}

putAJAXMarker.layers = [ ];
putAJAXMarker.bugs = { };

function init() {
    brokenContentSize = $("content").offsetWidth == 0;
    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
    OpenLayers.Util.onImageLoadErrorColor = "transparent";
    OpenLayers.Control.Permalink.prototype.updateLink = function() {
        var href = this.base;
        if (href.indexOf('#') != -1) {
            href = href.substring( 0, href.indexOf('#') );
        }
        if (href.indexOf('?') != -1) {
            href = href.substring( 0, href.indexOf('?') );
        }

        var query = OpenLayers.Util.getParameterString(this.createParams());
        if (query != "") query = "?" + query;

        href += query;
        if (this.hash)
                href += this.hash;

        this.element.href = href;
    }

    if (!location.hash) {
        //location.hash="#";
    }

    var options = {
        projection: new OpenLayers.Projection("EPSG:900913"),
        displayProjection: new OpenLayers.Projection("EPSG:4326"),
        units: "m",
        numZoomLevels: 18,
        maxResolution: 156543.0339,
        maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
                                         20037508, 20037508.34),
        controls: [
          new OpenLayers.Control.MouseDefaults(), 
          new OpenLayers.Control.PanZoomBar(), 
          new OpenLayers.Control.Attribution(), 
          new OpenLayers.Control.ScaleLine(), 
          new OpenLayers.Control.MousePosition(),
          new OpenLayers.Control.LayerSwitcher(),
          new OpenLayers.Control.Permalink(null, null, {"hash": document.location.hash})
//          new OpenLayers.Control.Permalink("editlink", "http://openstreetmap.org/edit", {"hash": document.location.hash}),
//          new OpenLayers.Control.Permalink("mini", "http://latlon.org/", {"hash": document.location.hash}),
//          new OpenLayers.Control.Permalink("maxi", "http://latlon.org/maxi", {"hash": document.location.hash}),
//          new OpenLayers.Control.Permalink("transport", "http://latlon.org/pt", {"hash": document.location.hash}),
//          new OpenLayers.Control.Permalink("sketchlink", "http://latlon.org/sketch", {"hash": document.location.hash}),
        ]
    };

    map = new OpenLayers.Map('map', options);
    belmapnik = new OpenLayers.Layer.OSM("LatLon Belarusian", "http://tile.latlon.org/tiles/${z}/${x}/${y}.png");
    var mapnik = new OpenLayers.Layer.OSM();
    var date = new Date();
//    cops = new OpenLayers.Layer.OSM("Traffic calming", "http://91.208.39.18/cops/${z}/${x}/${y}.png?" + date.getTime(), {numZoomLevels: 19,  isBaseLayer: false,  type: 'png', splayOutsideMaxExtent: true, visibility: true});

    //new OpenLayers.Layer.Markers("CafÃ©s");
    markers = new OpenLayers.Layer.Markers("Markers");

    var iconClosed = new OpenLayers.Icon("http://osb/images/closed_bug_marker.png", new OpenLayers.Size(22, 22), new OpenLayers.Pixel(-11, -11));
    var iconOpen = new OpenLayers.Icon("http://osb/images/open_bug_marker.png", new OpenLayers.Size(22, 22), new OpenLayers.Pixel(-11, -11));
    var iconKerb = new OpenLayers.Icon("http://osb/images/icon-border.png", new OpenLayers.Size(22, 22), new OpenLayers.Pixel(-11, -11));
    var iconCars = new OpenLayers.Icon("http://osb/images/carparking32.png", new OpenLayers.Size(36, 32), new OpenLayers.Pixel(-18, -21));
    var iconPedestrians = new OpenLayers.Icon("http://osb/images/old_folks32.png", new OpenLayers.Size(36, 32), new OpenLayers.Pixel(-18, -21));
    var iconStairs = new OpenLayers.Icon("http://osb/images/stairs32.png", new OpenLayers.Size(36, 32), new OpenLayers.Pixel(-18, -21));
    var iconDogs = new OpenLayers.Icon("http://osb/images/dog32.png", new OpenLayers.Size(36, 32), new OpenLayers.Pixel(-18, -21));
    var iconRoughRoad = new OpenLayers.Icon("http://osb/images/rough-road32.png", new OpenLayers.Size(36, 32), new OpenLayers.Pixel(-18, -21));

    var subtypeIcons = {
            "kerb": iconKerb,
            "parked cars": iconCars,
            "pedestrians": iconPedestrians,
            "stairs": iconStairs,
            "dogs": iconDogs,
            "rough road": iconRoughRoad
    };

    var osbLayer = new OpenLayers.Layer.OpenStreetBugs("OpenStreetBugs", { serverURL: "http://osb/api/0.1/", permalinkURL: "http://osb/", theme: "/css/openstreetbugs.css", iconOpen: iconOpen, iconClosed: iconClosed, subtypeIcons: subtypeIcons});
    osb = new OpenLayers.Control.OpenStreetBugs(osbLayer);
    map.addLayers([belmapnik, mapnik, markers, osbLayer]);
    //map.addLayers([osbLayer]);
    //cafes.preFeatureInsert = style_osm_feature; 

    selectControl = new OpenLayers.Control.Click(osbLayer, {"click": onFeatureSelect}, {"single": true, "double": false, "pixelTolerance": 0, "stopSingle": false, "stopDouble": false});
    selectControl.click = onFeatureSelect;
    map.addControl(selectControl);
    selectControl.activate();

    if (!map.getCenter()) {
        var lonlat, zoom;
        if (OpenLayers.Util.getParameters().mlon == null) {
            lonlat = new OpenLayers.LonLat(27.56813, 53.90313);
            zoom = 12;
        } else {
            lonlat = new OpenLayers.LonLat(OpenLayers.Util.getParameters().mlon,OpenLayers.Util.getParameters().mlat);
            if (OpenLayers.Util.getParameters().zoom == null) {
                zoom = 17;
            } else {
                zoom = OpenLayers.Util.getParameters().zoom;
            }
            markers.addMarker(new OpenLayers.Marker(lonlat));
        }
        lonlat.transform(map.displayProjection,map.projection);
        map.setCenter(lonlat, zoom);
        map.panTo(lonlat);
    }

    openSidebar({width: "20%"});
    handleResize();

    window.onload = handleResize;
    window.onresize = handleResize;

    var sorry = document.createElement("div");
    sorry.innerHTML = OpenLayers.i18n("New obstacles can be added on zoom level 17 or greater");
    sorry.id = "sorry";
    document.body.insertBefore(sorry, $("content"));
}


OpenLayers.Lang.ru = OpenLayers.Util.extend(OpenLayers.Lang.ru, {
    "Say": "Ð¡Ð¾Ð¾Ð±ÑÐ¸ÑÑ",
    "Your message:": "ÐÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹",
    "Type:": "ÐÐ¸Ð´:",
    "Your name:": "ÐÑÐµÐ´ÑÑÐ°Ð²ÑÑÐµÑÑ:",
    "NoName": "ÐÑÐ¾-ÑÐ¾",
    "Please fill in your name": "ÐÑÐµÐ´ÑÑÐ°Ð²ÑÑÐµÑÑ, Ð¿Ð¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°",
    "Comment is required": "ÐÐ¿Ð¸ÑÐ¸ÑÐµ, Ð¿Ð¾Ð¶Ð°Ð»ÑÐ¹ÑÑÐ°, ÐºÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹",
    "Something's wrong": "ÐÑÑÐ³Ð¾Ðµ",
    "Description": "ÐÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ",
    "Comment": "ÐÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹",
    "Permalink": "ÐÐ¾ÑÑÐ¾ÑÐ½Ð½Ð°Ñ ÑÑÑÐ»ÐºÐ°",
    "Zoom": "ÐÑÐ¸Ð±Ð»Ð¸Ð·Ð¸ÑÑ",
    "Unresolved Problem": "Ð¡ÑÑÐµÑÑÐ²ÑÑÑÐ°Ñ Ð¿ÑÐ¾Ð±Ð»ÐµÐ¼Ð°",
    "Fixed Problem": "ÐÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð¿ÑÐ¾Ð±Ð»ÐµÐ¼Ð°",
    "Change": "ÐÐ·Ð¼ÐµÐ½Ð¸ÑÑ",
    "Nickname": "ÐÑÐµÐ´ÑÑÐ°Ð²ÑÑÐµÑÑ",
    "Kerb" : "ÐÐ¾ÑÐ´ÑÑ",
    "kerb" : "Ð±Ð¾ÑÐ´ÑÑ",
    "Parked cars" : "ÐÐ°ÑÐ¸Ð½Ñ Ð½Ð° ÑÑÐ¾ÑÑÐ°ÑÐµ",
    "parked cars" : "Ð¼Ð°ÑÐ¸Ð½Ñ Ð½Ð° ÑÑÐ¾ÑÑÐ°ÑÐµ",
    "Pedestrians" : "ÐÐµÑÐµÑÐ¾Ð´Ñ",
    "pedestrians" : "Ð¿ÐµÑÐµÑÐ¾Ð´Ñ",
    "Stairs" : "Ð¡ÑÑÐ¿ÐµÐ½ÑÐºÐ¸",
    "stairs" : "ÑÑÑÐ¿ÐµÐ½ÑÐºÐ¸",
    "Dogs" : "Ð¡Ð¾Ð±Ð°ÐºÐ¸",
    "dogs" : "ÑÐ¾Ð±Ð°ÐºÐ¸",
    "rough road" : "Ð´ÐµÑÐµÐºÑÑ Ð¿Ð¾ÐºÑÑÑÐ¸Ñ",
    "Rough road" : "ÐÐµÑÐµÐºÑÑ Ð¿Ð¾ÐºÑÑÑÐ¸Ñ",
    "Mark as fixed" : "ÐÐ¾Ð¼ÐµÑÐ¸ÑÑ ÐºÐ°Ðº Ð¸ÑÐ¿ÑÐ°Ð²Ð»ÐµÐ½Ð½Ð¾Ðµ",
    "Add comment" : "ÐÐ¾Ð±Ð°Ð²Ð¸ÑÑ ÐºÐ¾Ð¼Ð¼ÐµÐ½ÑÐ°ÑÐ¸Ð¹",
    "Cancel" : "ÐÑÐ¼ÐµÐ½Ð°",
    "New obstacles can be added on zoom level 17 or greater": "ÐÐ¾Ð±Ð°Ð²Ð»ÑÑÑ ÑÐ²ÐµÐ´ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐ¾Ð»ÑÐºÐ¾ Ð½Ð° Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑÐ½Ð¾Ð¼ ÑÑÐ¾Ð²Ð½Ðµ Ð´ÐµÑÐ°Ð»Ð¸Ð·Ð°ÑÐ¸Ð¸"
});

OpenLayers.Lang.be = OpenLayers.Util.extend(OpenLayers.Lang.be, {
    "Say": "ÐÐ°Ð²ÐµÐ´Ð°Ð¼ÑÑÑ",
    "Your message:": "ÐÐ°Ð¼ÐµÐ½ÑÐ°Ñ",
    "Type:": "Ð¢ÑÐ¿:",
    "Your name:": "ÐÐ°ÑÐ°Ðµ ÑÐ¼Ñ:",
    "NoName": "ÐÐµÑÑÐ°",
    "Please fill in your name": "ÐÐ°Ð»Ñ Ð»Ð°ÑÐºÐ°, Ð¿Ð°Ð·Ð½Ð°ÑÑÐµ Ð²Ð°ÑÐ°Ðµ ÑÐ¼Ñ",
    "Comment is required": "ÐÐ°Ð¼ÐµÐ½ÑÐ°Ñ Ð°Ð±Ð°Ð²ÑÐ·ÐºÐ¾Ð²Ñ, Ð½Ð°Ð¿ÑÑÑÑÐµ ÑÐ³Ð¾, ÐºÐ°Ð»Ñ Ð»Ð°ÑÐºÐ°",
    "Something's wrong": "ÐÐ½ÑÐ°Ðµ",
    "Description": "ÐÐ¿ÑÑÐ°Ð½Ð½Ðµ",
    "Comment": "ÐÐ°Ð¼ÐµÐ½ÑÐ°Ñ",
    "Permalink": "Ð¡ÑÐ°Ð»Ð°Ñ ÑÐ¿Ð°ÑÑÐ»ÐºÐ°",
    "Zoom": "ÐÐ°Ð±Ð»ÑÐ·ÑÑÑ",
    "Unresolved Problem": "ÐÑÐ½ÑÑÑÐ°Ñ Ð¿ÑÐ°Ð±Ð»ÐµÐ¼Ð°",
    "Fixed Problem": "ÐÑÐ¿ÑÐ°ÑÐ»ÐµÐ½Ð°Ñ Ð¿ÑÐ°Ð±Ð»ÐµÐ¼Ð°",
    "Change": "ÐÐ¼ÑÐ½ÑÑÑ/Ð·Ð°ÐºÑÑÑÑ",
    "Nickname": "ÐÑÐ½ÑÑÐºÐ°",
    "Kerb" : "ÐÐ°ÑÐ´Ð·ÑÑ",
    "kerb" : "Ð±Ð°ÑÐ´Ð·ÑÑ",
    "Parked cars" : "ÐÐ°ÑÑÐ½Ñ Ð½Ð° ÑÐ¾Ð´Ð½ÑÐºÑ",
    "parked cars" : "Ð¼Ð°ÑÑÐ½Ñ Ð½Ð° ÑÐ¾Ð´Ð½ÑÐºÑ",
    "Pedestrians" : "ÐÐµÑÐ°ÑÐ¾Ð´Ñ",
    "pedestrians" : "Ð¿ÐµÑÐ°ÑÐ¾Ð´Ñ",
    "Stairs" : "ÐÑÑÑÑÑÐ¿ÐºÑ",
    "stairs" : "Ð¿ÑÑÑÑÑÐ¿ÐºÑ",
    "Dogs" : "Ð¡Ð°Ð±Ð°ÐºÑ",
    "dogs" : "ÑÐ°Ð±Ð°ÐºÑ",
    "rough road" : "Ð´ÑÑÐµÐºÑÑ Ð¿Ð°ÐºÑÑÑÑÑ",
    "Rough road" : "ÐÑÑÐµÐºÑÑ Ð¿Ð°ÐºÑÑÑÑÑ",
    "Mark as fixed" : "ÐÐ°Ð·Ð½Ð°ÑÑÑÑ ÑÐº Ð²ÑÐ¿ÑÐ°ÑÐ»ÐµÐ½Ð°Ðµ",
    "Add comment" : "ÐÐ°Ð´Ð°ÑÑ ÐºÐ°Ð¼ÐµÐ½ÑÐ°Ñ",
    "Cancel" : "Ð¡ÐºÐ°ÑÐ°Ð²Ð°ÑÑ",
    "New obstacles can be added on zoom level 17 or greater": "ÐÐ°Ð´Ð°Ð²Ð°ÑÑ Ð·Ð²ÐµÑÑÐºÑ Ð¼Ð¾Ð¶Ð½Ð° ÑÐ¾Ð»ÑÐºÑ Ð½Ð° Ð¼Ð°ÐºÑÑÐ¼Ð°Ð»ÑÐ½ÑÐ¼ ÑÐ·ÑÐ¾ÑÐ½Ñ Ð´ÑÑÐ°Ð»ÑÐ·Ð°ÑÑÑ"
});

